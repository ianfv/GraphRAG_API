name: Production

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"  # Matches v1.0.0, v2.1.3, etc.

jobs:
  validate-version:
    name: Validate Version Tag
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get-version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Release Version: $VERSION"

      - name: Validate version format
        run: |
          VERSION=${{ steps.get-version.outputs.version }}
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "‚ùå Invalid version format: $VERSION"
            echo "Expected format: MAJOR.MINOR.PATCH (e.g., 1.0.0)"
            exit 1
          fi
          echo "‚úÖ Version format is valid"

  test:
    name: Full Test Suite (Production)
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run comprehensive test suite
        run: |
          pytest tests/ -v --cov=src --cov-report=term-missing --cov-report=xml --cov-report=html --strict-markers

      - name: Enforce strict coverage threshold
        run: |
          COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(float(root.attrib['line-rate']) * 100)")
          echo "Coverage: ${COVERAGE}%"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "‚ùå Coverage ${COVERAGE}% is below 80% production threshold"
            exit 1
          else
            echo "‚úÖ Coverage ${COVERAGE}% meets 80% production threshold"
          fi

  lint:
    name: Strict Linting (Production)
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff

      - name: Run Ruff linter (production strict)
        run: |
          ruff check src/ tests/ --no-fix

      - name: Run Ruff formatter check
        run: |
          ruff format --check src/ tests/

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate-version
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run Safety check
        run: |
          safety check --json

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            python -c "import json; data=json.load(open('bandit-report.json')); high=len([x for x in data['results'] if x['issue_severity']=='HIGH']); print(f'High severity issues: {high}'); exit(1 if high > 0 else 0)"
          fi

  build-docker-placeholder:
    name: Build Production Docker Image (Placeholder)
    needs: [test, lint, security]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Placeholder - Production Docker build
        run: |
          echo "üê≥ Production Docker build will be implemented in Phase 3"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""
          echo "Future implementation:"
          echo "  - Build Docker image with version tag"
          echo "  - Push to AWS ECR"
          echo "  - Tag as 'latest' and version tag"
          echo "  - Sign container image"

  production-ready:
    name: Production Deployment Ready
    needs: [validate-version, test, lint, security, build-docker-placeholder]
    runs-on: ubuntu-latest
    steps:
      - name: Production readiness check
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "‚úÖ All production checks passed!"
          echo ""
          echo "üì¶ Release: v$VERSION"
          echo "üè∑Ô∏è  Tag: ${{ github.ref_name }}"
          echo "üìù Commit: ${{ github.sha }}"
          echo ""
          echo "‚úì Tests passed with ‚â•80% coverage"
          echo "‚úì Linting passed (strict mode)"
          echo "‚úì Security scan completed"
          echo ""
          echo "Next steps (manual for now):"
          echo "  1. Review release notes"
          echo "  2. Verify all production requirements met"
          echo "  3. Deploy to production environment"
          echo "  4. Monitor deployment health"
          echo ""
          echo "Future automation:"
          echo "  - Automatic Docker image build and push to ECR"
          echo "  - Deploy to ECS production cluster"
          echo "  - Blue-green deployment"
          echo "  - Automated rollback on failure"
          echo "  - Post-deployment health checks"

      - name: Create deployment summary
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # üöÄ Production Release v$VERSION

          ## Status: Ready for Deployment

          | Check | Status |
          |-------|--------|
          | Version Validation | ‚úÖ Passed |
          | Test Suite | ‚úÖ Passed |
          | Code Coverage | ‚úÖ ‚â•80% |
          | Linting | ‚úÖ Passed |
          | Security Scan | ‚úÖ Passed |
          | Docker Build | üîÑ Placeholder |

          ## Release Information
          - **Version**: v$VERSION
          - **Commit**: \`${{ github.sha }}\`
          - **Branch**: \`${{ github.ref_name }}\`
          - **Triggered by**: ${{ github.actor }}

          ## Next Steps
          Manual deployment required until Phase 3 automation is implemented.
          EOF
